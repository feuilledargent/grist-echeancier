<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Échéancier Prêt</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { margin-bottom: 15px; }
form input, form select { margin: 5px; padding: 5px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: right; }
th { background: #f0f0f0; }
.page-counter { text-align: center; font-weight: bold; }
.page-break { page-break-after: always; }
button { margin-top: 15px; padding: 10px 15px; background: #0078d7; color: #fff; border: none; cursor: pointer; }
button:hover { background: #005fa3; }
#btn-pdf { background: #28a745; }
#btn-pdf:hover { background: #1e7e34; }
</style>
</head>
<body>

<h1>Simulateur d'Échéancier</h1>

<form id="loan-form">
  <label>Montant (€): <input type="number" id="montant" required></label>
  <label>Taux annuel (%): <input type="number" step="0.01" id="taux" required></label>
  <label>Durée (années): <input type="number" id="dureeAnnees" required></label>
  <label>Date 1ère échéance: <input type="date" id="datePrem"></label>
  <label>Frais fixes par échéance (€): <input type="number" id="fraisFixes" value="0"></label>
  <button type="submit">Calculer</button>
</form>

<h2>Récapitulatif du prêt</h2>
<p>Montant : <span id="recap-montant">—</span> | Taux : <span id="recap-taux">—</span> | Mensualité : <span id="recap-mensualite">—</span> | Durée : <span id="recap-duree">—</span></p>
<p>Total intérêts : <span id="recap-interets">—</span> | Coût total crédit : <span id="recap-cout">—</span></p>

<table>
<thead>
<tr>
<th>№</th><th>Date</th><th>Capital initial</th><th>Intérêts</th><th>Frais</th><th>Capital remboursé</th><th>Capital final</th><th>Mensualité</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<button id="btn-print">Imprimer</button>
<button id="btn-pdf">Télécharger PDF</button>

<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
function fmtNum(n){return (n==null||isNaN(n))?"—":Number(n).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtDate(d){const dt=new Date(d);return isNaN(dt)?"—":dt.toLocaleDateString("fr-FR");}
function round2(n){return Math.round(Number(n)*100)/100;}

let rows=[];

document.getElementById("loan-form").addEventListener("submit",function(e){
  e.preventDefault();
  const montant=Number(document.getElementById("montant").value);
  const dureeAnnees=Number(document.getElementById("dureeAnnees").value);
  const duree=dureeAnnees*12;
  let tauxAnnuel=Number(document.getElementById("taux").value)/100;
  const fraisFixes=Number(document.getElementById("fraisFixes").value);
  const datePrem=document.getElementById("datePrem").value?new Date(document.getElementById("datePrem").value):new Date();

  const tauxMensuel=tauxAnnuel/12;
  let mensualiteBase=(tauxMensuel>0)?montant*tauxMensuel/(1-Math.pow(1+tauxMensuel,-duree)):montant/duree;
  mensualiteBase=round2(mensualiteBase);

  let capitalRestant=round2(montant);
  rows=[];
  let totalInterets=0,totalFrais=0;
  for(let i=1;i<=duree;i++){
    const interet=round2(capitalRestant*tauxMensuel);
    const frais=round2(fraisFixes);
    let capitalRemb=round2(mensualiteBase-interet);
    if(i===duree&&capitalRemb>capitalRestant)capitalRemb=capitalRestant;
    const capitalFinal=round2(capitalRestant-capitalRemb);
    const mensualiteTotale=round2(mensualiteBase+frais);
    const dateEch=new Date(datePrem.getFullYear(),datePrem.getMonth()+(i-1),datePrem.getDate());
    rows.push({Numero:i,Date:dateEch,CapitalInitial:capitalRestant,Interets:interet,MontantFrais:frais,CapitalRembourse:capitalRemb,CapitalFinal:capitalFinal,Mensualite:mensualiteTotale});
    totalInterets=round2(totalInterets+interet);
    totalFrais=round2(totalFrais+frais);
    capitalRestant=capitalFinal;
  }
  const coutTotal=round2(montant+totalInterets+totalFrais);

  document.getElementById("recap-montant").textContent=fmtNum(montant);
  document.getElementById("recap-taux").textContent=(tauxAnnuel*100).toFixed(3)+" %";
  document.getElementById("recap-mensualite").textContent=fmtNum(mensualiteBase);
  document.getElementById("recap-duree").textContent=duree+" mois";
  document.getElementById("recap-interets").textContent=fmtNum(totalInterets);
  document.getElementById("recap-cout").textContent=fmtNum(coutTotal);

  const tb=document.getElementById("tbody");
  tb.innerHTML="";
  for(const r of rows){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.Numero}</td><td>${fmtDate(r.Date)}</td><td>${fmtNum(r.CapitalInitial)}</td><td>${fmtNum(r.Interets)}</td><td>${fmtNum(r.MontantFrais)}</td><td>${fmtNum(r.CapitalRembourse)}</td><td>${fmtNum(r.CapitalFinal)}</td><td>${fmtNum(r.Mensualite)}</td>`;
    tb.appendChild(tr);
  }
});

document.getElementById("btn-print").addEventListener("click",()=>{parent.print();});

document.getElementById("btn-pdf").addEventListener("click",()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });
  doc.setFontSize(14);
  doc.text("Échéancier du prêt", 40, 40);
  doc.setFontSize(10);
  doc.text(`Montant: ${document.getElementById("recap-montant").textContent}`, 40, 70);
  doc.text(`Taux: ${document.getElementById("recap-taux").textContent}`, 40, 85);
  doc.text(`Mensualité: ${document.getElementById("recap-mensualite").textContent}`, 40, 100);
  doc.text(`Durée: ${document.getElementById("recap-duree").textContent}`, 40, 115);
  doc.text(`Total intérêts: ${document.getElementById("recap-interets").textContent}`, 40, 130);
  doc.text(`Coût total: ${document.getElementById("recap-cout").textContent}`, 40, 145);

  let y = 180;
  rows.forEach((r)=>{
    doc.text(`${r.Numero} | ${fmtDate(r.Date)} | ${fmtNum(r.CapitalInitial)} | ${fmtNum(r.Interets)} | ${fmtNum(r.MontantFrais)} | ${fmtNum(r.CapitalRembourse)} | ${fmtNum(r.CapitalFinal)} | ${fmtNum(r.Mensualite)}`, 40, y);
    y += 15;
    if(y > 750){ doc.addPage(); y = 40; }
  });

  doc.save("echeancier.pdf");
});
</script>

</body>
</html>
