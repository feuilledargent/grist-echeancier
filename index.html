<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Échéancier Prêt</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
h1 { margin-bottom: 15px; }
form label { display: inline-block; margin: 8px 12px; }
form input { padding: 6px; width: 120px; }
button padding: 10px 15px; background: #0078d7; color: #fff; border: none; cursor: pointer; border-radius: 4px; }
button:hover { background: #005fa3; }
#btn-pdf { background: #28a745; }
#btn-pdf:hover { background: #1e7e34; }

.recap-box {
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 15px;
  margin-top: 20px;
  background: #fafafa;
}
.recap-box h2 { margin-top: 0; font-size: 18px; }
.recap-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  font-size: 14px;
}
.re-grid strong { display: inline-block; min-width: 140px; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  font-size: 13px;
}
th {
  background: #f0f0f0;
  font-weight: bold;
  text-align: right;
  padding: 8px;
}
td {
  border-top: 1px solid #ddd;
  padding: 6px;
  text-align: right;
}
tbody tr:nth-child(even) { background: #fafafa; }
</style>
</head>
<body>

<h1>Simulateur d'Échéancier</h1>

<form id="loan-form">
  <label>Montant (€): <input type="number" id="montant" required></label>
  <label>Taux annuel (%): <input type="number" step="0.01" id="taux" required></label>
  <label>Durée (années): <input type="number" id="dureeAnnees" required></label>
  <label>Date 1ère échéance: <input type="date" id="datePrem"></label>
  <label>Frais fixes (€): <input type="number" id="fraisFixes" value="0"></label>
  <button type="submit">Calculer</button>
</form>

<div class="recap-box">
  <h2>Récapitulatif du prêt</h2>
  <div class="recap-grid">
    <div><strong>Montant :</strong> <span id="recap-montant">—</span></div>
    <div><strong>Taux :</strong> <span id="recap-taux">—</span></div>
    <div><strong>Mensualité :</strong> <span id="recap-mensualite">—</span></div>
    <div><strong>Durée :</strong> <span id="recap-duree">—</span></div>
    <div><strong>Total intérêts :</strong> <span id="recap-interets">—</span></div>
    <div><strong>Coût total crédit :</strong> <span id="recap-cout">—</span></div>
  </div>
</div>

<table>
<thead>
<tr>
<th>№</th><th>Date</th><th>Capital initial</th><th>Intérêts</th><th>Frais</th><th>Capital remboursé</th><th>Capital final</th><th>Mensualité</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<button id="btn-pdf">Télécharger PDF</button>

<!-- jsPDF + autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
function fmtNum(n){return (n==null||isNaN(n))?"—":Number(n).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtDate(d){const dt=new Date(d);return isNaN(dt)?"—":dt.toLocaleDateString("fr-FR");}
function round2(n){return Math.round(Number(n)*100)/100;}

let rows=[];

document.getElementById("loan-form").addEventListener("submit",function(e){
  e.preventDefault();
  const montant=Number(document.getElementById("montant").value);
  const dureeAnnees=Number(document.getElementById("dureeAnnees").value);
  const duree=dureeAnnees*12;
  let tauxAnnuel=Number(document.getElementById("taux").value)/100;
  const fraisFixes=Number(document.getElementById("fraisFixes").value);
  const datePrem=document.getElementById("datePrem").value?new Date(document.getElementById("datePrem").value):new Date();

  const tauxMensuel=tauxAnnuel/12;
  let mensualiteBase=(tauxMensuel>0)?montant*tauxMensuel/(1-Math.pow(1+tauxMensuel,-duree)):montant/duree;
  mensualiteBase=round2(mensualiteBase);

  let capitalRestant=round2(montant);
  rows=[];
  let totalInterets=0,totalFrais=0;
  for(let i=1;i<=duree;i++){
    const interet=round2(capitalRestant*tauxMensuel);
    const frais=round2(fraisFixes);
    let capitalRemb=round2(mensualiteBase-interet);
    if(i===duree&&capitalRemb>capitalRestant)capitalRemb=capitalRestant;
    const capitalFinal=round2(capitalRestant-capitalRemb);
    const mensualiteTotale=round2(mensualiteBase+frais);
    const dateEch=new Date(datePrem.getFullYear(),datePrem.getMonth()+(i-1),datePrem.getDate());
    rows.push([i, fmtDate(dateEch), fmtNum(capitalRestant), fmtNum(interet), fmtNum(frais), fmtNum(capitalRemb), fmtNum(capitalFinal), fmtNum(mensualiteTotale)]);
    totalInterets=round2(totalInterets+interet);
    totalFrais=round2(totalFrais+frais);
    capitalRestant=capitalFinal;
  }
  const coutTotal=round2(montant+totalInterets+totalFrais);

  document.getElementById("recap-montant").textContent=fmtNum(montant);
  document.getElementById("recap-taux").textContent=(tauxAnnuel*100).toFixed(3)+" %";
  document.getElementById("recap-mensualite").textContent=fmtNum(mensualiteBase);
  document.getElementById("recap-duree").textContent=duree+" mois";
  document.getElementById("recap-interets").textContent=fmtNum(totalInterets);
  document.getElementById("recap-cout").textContent=fmtNum(coutTotal);

  const tb=document.getElementById("tbody");
  tb.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td>`;
    tb.appendChild(tr);
  });
});

document.getElementById("btn-pdf").addEventListener("click",()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Récapitulatif du prêt", 105, 20, { align: "center" });
  doc.setFontSize(11);
  doc.text(`Montant : ${document.getElementById("recap-montant").textContent}`, 14, 35);
  doc.text(`Taux : ${document.getElementById("recap-taux").textContent}`, 14, 45);
  doc.text(`Mensualité : ${document.getElementById("recap-mensualite").textContent}`, 14, 55);
  doc.text(`Durée : ${document.getElementById("recap-duree").textContent}`, 14, 65);
  doc.text(`Total intérêts : ${document.getElementById("recap-interets").textContent}`, 14, 75);
  doc.text(`Coût total crédit : ${document.getElementById("recap-cout").textContent}`, 14, 85);

  doc.autoTable({
    startY: 100,
    head: [["№","Date","Capital initial","Intérêts","Frais","Capital remboursé","Capital final","Mensualité"]],
    body: rows,
    styles: { fontSize: 9, halign: 'right' },
    headStyles: { fillColor: [240,240,240], textColor: 0, fontStyle: 'bold' },
    alternateRowStyles: { fillColor: [250,250,250] }
  });

  doc.save("echeancier.pdf");
});
</script>

</body>
</html>
