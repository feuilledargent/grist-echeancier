<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Échéancier Prêt</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h 5px; padding: 5px; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: right; }
th { background: #f0f0f0; }
button { margin-top: 15px; padding: 10px 15px; background: #0078d7; color: #fff; border: none; cursor: pointer; }
button:hover { background: #005fa3; }
#btn-pdf { background: #28a745; }
#btn-pdf:hover { background: #1e7e34; }
</style>
</head>
<body>

<h1>Simulateur d'Échéancier</h1>

<formMontant (€): <input type="number" id="montant" required></label>
  <label>Taux annuel (%): <input type="number" step="0.01" id="taux" required></label>
  <label>Durée (années): <input type="number" id="dureeAnnees" required></label>
  <label>Date 1ère échéance: <input type="date" id="datePrem"></label>
  <label>Frais fixes (€): <input type="number" id="fraisFixes" value="0"></label>
  <button type="submit">Calculer</button>
</form>

<h2>Récapitulatif du prêt</h2>
<p>Montant : <span id="recap-montant">—</span> | Taux : <span id="recap-taux">—</span> | Mensualité : <span id="recap-mensualite">—</span> | Durée : <span id="recap-duree">—</span></p>
<p>Total intérêts : <span id="recap-interets">—</span> | Coût total crédit : <span id="recap-cout">—</span></p>

<table>
<thead>
<tr>
<th>№</th><th>Date</th><th>Capital initial</th><th>Intérêts</th><th>Frais</th><th>Capital remboursé</th><th>Capital final</th><th>Mensualité</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<button id="btn-pdf">Télécharger PDF</button>

<!-- jsPDF + autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
function fmtNum(n){return (n==null||isNaN(n))?"—":Number(n).toLocaleString("fr-FR",{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtDate(d){const dt=new Date(d);return isNaN(dt)?"—":dt.toLocaleDateString("fr-FR");}
function round2(n){return Math.round(Number(n)*100)/100;}

let rows=[];

document.getElementById("loan-form").addEventListener("submit",function(e){
  e.preventDefault();
  const montant=Number(document.getElementById("montant").value);
  const dureeAnnees=Number(document.getElementById("dureeAnnees").value);
  const duree=dureeAnnees*12;
  let tauxAnnuel=Number(document.getElementById("taux").value)/100;
  const fraisFixes=Number(document.getElementById("fraisFixes").value);
  const datePrem=document.getElementById("datePrem").value?new Date(document.getElementById("datePrem").value):new Date();

  const tauxMensuel=tauxAnnuel/12;
  let mensualiteBase=(tauxMensuel>0)?montant*tauxMensuel/(1-Math.pow(1+tauxMensuel,-duree)):montant/duree;
  mensualiteBase=round2(mensualiteBase);

  let capitalRestant=round2(montant);
  rows=[];
  let totalInterets=0,totalFrais=0;
  for(let i=1;i<=duree;i++){
    const interet=round2(capitalRestant*tauxMensuel);
    const frais=round2(fraisFixes);
    let capitalRemb=round2(mensualiteBase-interet);
    if(i===duree&&capitalRemb>capitalRestant)capitalRemb=capitalRestant;
    const capitalFinal=round2(capitalRestant-capitalRemb);
    const mensualiteTotale=round2(mensualiteBase+frais);
    const dateEch=new Date(datePrem.getFullYear(),datePrem.getMonth()+(i-1),datePrem.getDate());
    rows.push([i, fmtDate(dateEch), fmtNum(capitalRestant), fmtNum(interet), fmtNum(frais), fmtNum(capitalRemb), fmtNum(capitalFinal), fmtNum(mensualiteTotale)]);
    totalInterets=round2(totalInterets+interet);
    totalFrais=round2(totalFrais+frais);
    capitalRestant=capitalFinal;
  }
  const coutTotal=round2(montant+totalInterets+totalFrais);

  document.getElementById("recap-montant").textContent=fmtNum(montant);
  document.getElementById("recap-taux").textContent=(tauxAnnuel*100).toFixed(3)+" %";
  document.getElementById("recap-mensualite").textContent=fmtNum(mensualiteBase);
  document.getElementById("recap-duree").textContent=duree+" mois";
  document.getElementById("recap-interets").textContent=fmtNum(totalInterets);
  document.getElementById("recap-cout").textContent=fmtNum(coutTotal);

  const tb=document.getElementById("tbody");
  tb.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td>${r[6]}</td><td>${r[7]}</td>`;
    tb.appendChild(tr);
  });
});

document.getElementById("btn-pdf").addEventListener("click",()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("Échéancier du prêt", 14, 20);
  doc.setFontSize(10);
  doc.text(`Montant: ${document.getElementById("recap-montant").textContent}`, 14, 30);
  doc.text(`Taux: ${document.getElementById("recap-taux").textContent}`, 14, 36);
  doc.text(`Mensualité: ${document.getElementById("recap-mensualite").textContent}`, 14, 42);
  doc.text(`Durée: ${document.getElementById("recap-duree").textContent}`, 14, 48);
  doc.text(`Total intérêts: ${document.getElementById("recap-interets").textContent}`, 14, 54);
  doc.text(`Coût total: ${document.getElementById("recap-cout").textContent}`, 14, 60);

  doc.autoTable({
    startY: 70,
    head: [["№","Date","Capital initial","Intérêts","Frais","Capital remboursé","Capital final","Mensualité"]],
    body: rows,
    styles: { fontSize: 8, cellPadding: 2 },
    headStyles: { fillColor: [40,167,69] }
  });

  doc.save("echeancier.pdf");
});
</script>

</body>
</html>
